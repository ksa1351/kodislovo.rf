<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Контрольная — Русский ЕГЭ (оболочка)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --text:#e9ecff; --muted:#b8c0ff;
      --btn:#2b3a7a; --btn2:#1f2a57; --hl:#ffeb3b;
      --radius:16px; --ok:#35d07f; --bad:#ff5b6e; --line:#27305a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#070a14,#0b1020 30%,#070a14);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.9);backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line); padding:14px}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    h1{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1fr;gap:12px;margin:12px 0 28px}
    .card{background:rgba(18,26,51,.92);border:1px solid var(--line);border-radius:var(--radius);
      padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .qtop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .qid{font-weight:800}
    .qhint{color:var(--muted);font-size:12px}
    .qtext{margin:10px 0 12px;line-height:1.5}
    .ansrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"]{
      flex: 1 1 280px;
      padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0b1228;color:var(--text);outline:none;
    }
    input[type="text"]:focus{border-color:#3a4aa0}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;border-radius:12px;padding:11px 14px;cursor:pointer;color:var(--text);
      background:var(--btn);font-weight:700
    }
    button.secondary{background:var(--btn2)}
    button:active{transform:translateY(1px)}
    .pill{display:inline-flex;align-items:center;gap:8px;
      background:#0b1228;border:1px solid var(--line);padding:8px 10px;border-radius:999px}
    .score{font-weight:800}
    .tag{font-size:12px;color:var(--muted)}
    .mark{margin-top:10px;font-weight:800;padding:8px 10px;border-radius:12px;display:none}
    .mark.ok{display:inline-block;background:rgba(53,208,127,.14);border:1px solid rgba(53,208,127,.35);color:var(--ok)}
    .mark.bad{display:inline-block;background:rgba(255,91,110,.12);border:1px solid rgba(255,91,110,.35);color:var(--bad)}
    .small{font-size:12px;color:var(--muted);margin-top:8px;display:none}
    .small.show{display:block}
    footer{color:var(--muted);font-size:12px;padding:0 14px 24px}
    .grade{font-weight:900}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <h1 id="title">Контрольная работа (HTML5)</h1>
    <div class="sub" id="subtitle">
      Загрузка варианта…
    </div>

    <div class="btnbar" style="margin-top:10px">
      <div class="pill">
        <span class="tag">Баллы:</span>
        <span class="score" id="score">0</span>/<span class="score" id="total">0</span>
      </div>
      <div class="pill">
        <span class="tag">Процент:</span>
        <span class="score" id="percent">0%</span>
      </div>
      <div class="pill">
        <span class="tag">Отметка:</span>
        <span class="score grade" id="grade">—</span>
      </div>

      <button id="checkAll">Проверить всё</button>
      <button class="secondary" id="resetAll">Сброс</button>
      <button class="secondary" id="toggleKeys">Показать/скрыть ключи</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid" id="cards"></div>
</main>

<footer class="wrap">
  Оценивание тестовой части: задания с кратким ответом проверяются по ключам (ФИПИ: 1 балл за большинство заданий тестовой части; в полной модели 8 и 22 — 2 балла, но в этом варианте они исключены). :contentReference[oaicite:1]{index=1}
</footer>

<script>
/* ===================== НАСТРОЙКИ ===================== */
const DATA_URL = "./variant26_cut.json"; // меняете только этот файл — оболочка не переписывается

// шкала в отметку (по вашему правилу)
function percentToGrade(p){
  if (p >= 87) return 5;
  if (p >= 67) return 4;
  if (p >= 42) return 3;
  return 2;
}

/* ===================== УТИЛИТЫ ===================== */
const $ = (s, r=document) => r.querySelector(s);

function normText(s){
  if(s == null) return "";
  return String(s)
    .trim()
    .toLowerCase()
    .replaceAll("ё","е")
    .replace(/[.,;:!?]+$/g,"")
    .replace(/\s+/g," ");
}

function normNums(s){
  // разрешаем ввод "1 2 4", "1,2,4" и т.п. → "124" (с сортировкой)
  const raw = normText(s).replace(/[^0-9]/g,"");
  return raw.split("").sort().join("");
}

function isNumericKey(key){
  return /^[0-9]+$/.test(key);
}

function checkAnswer(user, keys, mode){
  const u0 = normText(user);
  if(!u0) return {ok:false, normalized:""};

  // mode: "nums" | "text" | "auto"
  if(mode === "nums" || (mode !== "text" && keys.some(isNumericKey))){
    const un = normNums(user);
    const keyNorms = keys.map(k => normNums(k));
    return {ok: keyNorms.includes(un), normalized: un};
  }

  // text: игнорируем пробелы (удобно для пар/словосочетаний)
  const un = normText(user).replace(/\s/g,"");
  const keyNorms = keys.map(k => normText(k).replace(/\s/g,""));
  return {ok: keyNorms.includes(un), normalized: un};
}

/* ===================== СОСТОЯНИЕ ===================== */
let data = null;
let showKeys = false;

/* ===================== РЕНДЕР ===================== */
function render(){
  $("#title").textContent = data.meta?.title || "Контрольная";
  $("#subtitle").textContent = data.meta?.subtitle || "";

  const tasks = data.tasks || [];
  const cards = $("#cards");
  cards.innerHTML = "";

  // максимум (сумма баллов)
  const maxPoints = tasks.reduce((s,t)=>s + (Number(t.points)||0), 0);
  $("#total").textContent = String(maxPoints);

  tasks.forEach(t => {
    const card = document.createElement("section");
    card.className = "card";
    card.dataset.id = t.id;

    const pts = Number(t.points)||0;

    card.innerHTML = `
      <div class="qtop">
        <div>
          <div class="qid">Задание ${t.id}</div>
          <div class="qhint">${t.hint || ""}</div>
        </div>
        <div class="pill">
          <span class="tag">Баллы:</span>
          <span class="score" id="pt-${t.id}">0</span>/${pts}
        </div>
      </div>

      <div class="qtext">${t.text}</div>

      <div class="ansrow">
        <input type="text" id="in-${t.id}" placeholder="Введите ответ…" autocomplete="off" />
        <button class="secondary" id="chk-${t.id}">Проверить</button>
      </div>

      <div class="mark" id="mk-${t.id}"></div>
      <div class="small" id="key-${t.id}"><b>Ключ:</b> ${(t.answers||[]).join(" / ")}</div>
    `;

    cards.appendChild(card);

    $(`#chk-${t.id}`).addEventListener("click", () => checkOne(t.id));
    $(`#in-${t.id}`).addEventListener("keydown", (e) => {
      if(e.key === "Enter") checkOne(t.id);
    });
  });

  applyKeysVisibility();
  updateTotals();
}

function applyKeysVisibility(){
  (data.tasks||[]).forEach(t => {
    const el = $(`#key-${t.id}`);
    if(!el) return;
    el.classList.toggle("show", showKeys);
  });
}

function setMark(id, ok, msg){
  const mk = $(`#mk-${id}`);
  mk.className = "mark " + (ok ? "ok" : "bad");
  mk.textContent = msg;
}

function setPoints(id, p){
  const el = $(`#pt-${id}`);
  if(el) el.textContent = String(p);
}

function checkOne(id){
  const t = (data.tasks||[]).find(x => String(x.id) === String(id));
  const input = $(`#in-${id}`);
  const pts = Number(t.points)||0;

  const {ok} = checkAnswer(input.value, t.answers||[], t.mode || "auto");

  if(ok){
    setPoints(id, pts);
    setMark(id, true, "Верно ✅");
  }else{
    setPoints(id, 0);
    setMark(id, false, "Неверно ❌");
  }
  updateTotals();
}

function checkAll(){
  (data.tasks||[]).forEach(t => checkOne(t.id));
}

function resetAll(){
  (data.tasks||[]).forEach(t => {
    const inp = $(`#in-${t.id}`);
    if(inp) inp.value = "";
    setPoints(t.id, 0);
    const mk = $(`#mk-${t.id}`);
    if(mk){
      mk.className = "mark";
      mk.textContent = "";
      mk.style.display = "none";
      mk.style.display = "";
    }
  });
  updateTotals();
}

function updateTotals(){
  const tasks = data.tasks || [];
  const got = tasks.reduce((s,t)=>s + Number($(`#pt-${t.id}`)?.textContent || 0), 0);
  const max = tasks.reduce((s,t)=>s + (Number(t.points)||0), 0);

  $("#score").textContent = String(got);

  const pct = max ? Math.round((got / max) * 100) : 0;
  $("#percent").textContent = pct + "%";
  $("#grade").textContent = max ? String(percentToGrade(pct)) : "—";
}

/* ===================== ЗАГРУЗКА ДАННЫХ ===================== */
async function load(){
  const r = await fetch(DATA_URL, {cache:"no-store"});
  if(!r.ok) throw new Error("Не удалось загрузить файл заданий: " + r.status);
  data = await r.json();
  render();
}

$("#checkAll").addEventListener("click", checkAll);
$("#resetAll").addEventListener("click", resetAll);
$("#toggleKeys").addEventListener("click", () => {
  showKeys = !showKeys;
  applyKeysVisibility();
});

load().catch(err => {
  $("#subtitle").textContent = "Ошибка: " + err.message;
});
</script>

</body>
</html>
